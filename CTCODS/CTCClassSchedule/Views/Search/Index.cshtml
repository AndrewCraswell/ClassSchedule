@using Ctc.Ods.Types;
@using CTCClassSchedule;
@using CTCClassSchedule.Common;
@using MvcMiniProfiler;
@using System.Text.RegularExpressions;
@using System.Globalization;
@model CTCClassSchedule.SearchResultsModel

@{
	MiniProfiler _profiler = MiniProfiler.Current;

	// NOTE: we should always have a YearQuarter (searching all quarters is not an option)
	YearQuarter yrq = ViewBag.YearQuarter;

	int itemCount = ViewBag.ItemCount ?? 0;
	int subjectCount = ViewBag.SubjectCount ?? 0;
	String classDesc = subjectCount == 1 ? "class" : "classes";
	String sectionDesc = itemCount == 1 ? "section" : "sections";

	IDictionary<string, object> _routeValues = ViewBag.RouteValues;
	_routeValues["YearQuarterID"] = "All";

	string PreviousCourseID = string.Empty;
	string PreviousSectionID = string.Empty;
}
<script type="text/javascript" src="@Url.Content("~/Scripts/CtcClassSchedule.js")"></script>
<script type="text/javascript">

	$(document).ready(function () {

		//highlight all of the words that match the search term, respecting case.
		$(".classHeading,#courseDescription").each(function () {
			$(this).html($(this).html().replace(/([^\/])(@(ViewBag.searchterm))([^\/]??)/ig, '$1<em class="keyword">$2</em>'));
		});

		//end of highlight
	});

</script>
<div id="scheduleMain">
    @Html.Partial("quarterNavigation")
    <div id="container" class="sidebar">
        <div id="sidebar">
            @Html.Partial("advancedFacetedSearch", Model.Section)
            @Html.Partial("basicFacetedSearch")
        </div> <!-- #sidebar -->

        <div id="content">



	<div id="searchHeaderInfo">
		<h1 id="searchResultsMsg">
			<strong>"@(ViewBag.searchterm)"</strong> found @itemCount @sectionDesc in @subjectCount @classDesc for @(yrq != null ? yrq.FriendlyName : "ERROR")
		</h1>
		<div id="searchPageNum">
			page @ViewBag.CurrentPage of @ViewBag.TotalPages
		</div>
	</div>

	@if (itemCount == 0)
	{
			<h3>No classes found.</h3>
	}
	else
	{
		using (_profiler.Step("Rendering sections from search results"))
	{
		foreach (SectionWithSeats sec in Model.Section)
		{
			string courseID = sec.CourseID;
			string sectionID = sec.ID.ToString();

			if (PreviousCourseID != courseID)
			{
			_routeValues["Subject"] = sec.CourseSubject;
			_routeValues["ClassNum"] = sec.CourseNumber;

				<text>
		<h2 class="classHeading">
			@Html.ActionLink(string.Format("{0}{1} {2} {3} • {4} Cr.", sec.CourseSubject, sec.IsCommonCourse ? "&" : string.Empty, sec.CourseNumber, sec.CourseTitle, Html.CreditsValue(sec.Credits)),
											"ClassDetails",
											"Classes",
											new RouteValueDictionary(_routeValues),
											null)
		</h2>
		<p class="classDetails">
			@Html.ActionLink("View Class Details", "ClassDetails", "Classes", new RouteValueDictionary(_routeValues), null)
		</p>

		<p class="courseDescription">
				@(sec.CourseDescriptions.Count() == 0 ? "" : @sec.CourseDescriptions[0].Description)
		</p>

		<p class="courseFootnotes">
				@(sec.CourseFootnotes == null ? "" : @sec.CourseFootnotes)
		</p>

		<ul class='course-block'>
		</text>
	 }

	 if (sectionID != PreviousSectionID)
	 {
			Html.RenderPartial("Sections", sec, new ViewDataDictionary { { "PreviousSectionID", PreviousSectionID } });
	 }

	 if (courseID != PreviousCourseID)
	 {
		@:</ul>
	 }
			PreviousSectionID = sectionID;
			PreviousCourseID = courseID;

		} @* end foreach(sec) *@
	}
	}

	</div> <!-- #content -->

    @if(ViewBag.TotalPages == 1 && Model.SearchResultNoSection.Count() > 0){
		Html.RenderPartial("NoSectionCourses", Model.SearchResultNoSection);
	}

	@{Html.RenderPartial("Pager");}

    </div> <!-- #container -->
</div>

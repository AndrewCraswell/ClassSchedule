@using CTCClassSchedule
@using CTCClassSchedule.Common
@using CTCClassSchedule.Controllers
@using MvcMiniProfiler;
@model IEnumerable<CTCClassSchedule.SectionWithSeats>
@{
	MiniProfiler _profiler = MiniProfiler.Current;

	IDictionary<string, object> _routeValues = ViewBag.RouteValues;
	_routeValues["YearQuarterID"] = "All";

	string PreviousCourseID = string.Empty;
	string PreviousSectionID = string.Empty;
}

<script type="text/javascript" src="@Url.Content("~/Scripts/CtcClassSchedule.js")"></script>

<div id="scheduleMain">
	@Html.Partial("quarterNavigation")
	@Html.Partial("advancedFacetedSearch")
    @Html.Partial("basicFacetedSearch")
	<div id="scheduleContent">
		@if (Model.Count() == 0)
	{
			<h3>No classes found.</h3>
	}
	else
	{
		<h1 class="program-title">
				@ViewBag.ProgramTitle
							<span class="subjectchooser">@Html.Partial("subjectNavigation")</span>
		</h1>

		if (!string.IsNullOrWhiteSpace(ViewBag.ProgramUrl))
		{
		<p id="programWebsite">
			<a href="@ViewBag.ProgramUrl" class="programWebsite">Program Website</a>
		</p>
		}

		using (_profiler.Step("Rendering sections by course"))
		{
			foreach (var sec in Model.OrderBy(c => c.CourseNumber).ThenBy(c => c.ID.ItemNumber))
			{
				string courseID = sec.CourseID;
				string sectionID = sec.ID.ToString();

				if (courseID != PreviousCourseID)
				{
				_routeValues["Subject"] = sec.CourseSubject;
				_routeValues["ClassNum"] = sec.CourseNumber;

					<text>
		<h2 class="classHeading">
		@Html.ActionLink(string.Format("{0}{1} {2} {3} • {4} Cr.", sec.CourseSubject, sec.IsCommonCourse ? "&" : string.Empty, sec.CourseNumber, sec.CourseTitle, Html.CreditsValue(sec.Credits)),
										"ClassDetails",
										"Classes",
										new RouteValueDictionary(_routeValues),
										null)
		</h2>
		<p class="classDetails">
			@Html.ActionLink("View Class Details", "ClassDetails", "Classes", new RouteValueDictionary(_routeValues), null)
		</p>
		<ul class='course-block'>
		</text>
		}

		if (PreviousSectionID != sectionID)
		{
			Html.RenderPartial("Sections", sec, new ViewDataDictionary { { "PreviousSectionID", PreviousSectionID } });
		}

				if (courseID != PreviousCourseID)
				{
		@:</ul>
		}
			PreviousSectionID = sectionID;
			PreviousCourseID = courseID;
			}
		}
}
	</div>
</div>
